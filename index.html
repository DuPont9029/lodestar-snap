<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Lodestar Snap Dashboard</title>
    <style>
      :root {
        --primary: #6366f1; /* Indigo 500 */
        --primary-hover: #4f46e5; /* Indigo 600 */
        --bg: #0f172a; /* Slate 900 */
        --card-bg: #1e293b; /* Slate 800 */
        --text: #f8fafc; /* Slate 50 */
        --text-muted: #94a3b8; /* Slate 400 */
        --border: #334155; /* Slate 700 */
        --success: #10b981; /* Emerald 500 */
        --code-bg: #020617; /* Slate 950 */
      }

      body {
        font-family:
          system-ui,
          -apple-system,
          sans-serif;
        background-color: var(--bg);
        color: var(--text);
        margin: 0;
        padding: 2rem;
        line-height: 1.6;
      }

      .container {
        max-width: 900px;
        margin: 0 auto;
      }

      header {
        text-align: center;
        margin-bottom: 3rem;
        padding-bottom: 2rem;
        border-bottom: 1px solid var(--border);
      }

      h1 {
        font-size: 2.5rem;
        font-weight: 800;
        margin: 0 0 0.5rem 0;
        background: linear-gradient(135deg, #818cf8 0%, #c084fc 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
      }

      .btn {
        background-color: var(--primary);
        color: white;
        border: none;
        padding: 0.75rem 1.5rem;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: background-color 0.2s;
        font-size: 1rem;
      }

      .btn:hover {
        background-color: var(--primary-hover);
      }

      .btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      .grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 1.5rem;
        margin-bottom: 1.5rem;
      }

      .card {
        background: var(--card-bg);
        border: 1px solid var(--border);
        border-radius: 16px;
        padding: 1.5rem;
      }

      pre {
        background: var(--code-bg);
        padding: 1rem;
        border-radius: 8px;
        overflow-x: auto;
        font-family: "Menlo", "Monaco", monospace;
        font-size: 0.9em;
        color: var(--success);
      }

      .status-indicator {
        display: inline-block;
        width: 10px;
        height: 10px;
        border-radius: 50%;
        background-color: #ef4444; /* Red */
        margin-right: 8px;
      }

      .status-indicator.active {
        background-color: var(--success);
        box-shadow: 0 0 10px var(--success);
      }
    </style>
  </head>
  <body>
    <div class="container">
      <header>
        <h1>Lodestar Snap Dashboard</h1>
        <p style="color: var(--text-muted)">
          Connect MetaMask directly to the Light Client Network
        </p>
      </header>

      <div class="card" style="margin-bottom: 2rem; text-align: center">
        <h2>1. Connection</h2>
        <div style="margin-bottom: 1rem">
          <span id="status-dot" class="status-indicator"></span>
          <span id="connection-status">Not Connected</span>
        </div>
        <button id="connect-btn" class="btn">Connect & Install Snap</button>
      </div>

      <div class="grid">
        <div class="card">
          <h3>2. Initialization</h3>
          <p>Start the internal Lodestar node.</p>
          <button id="init-btn" class="btn" disabled>Initialize Node</button>
          <div id="init-output" style="margin-top: 1rem"></div>
        </div>

        <div class="card">
          <h3>3. RPC Bridge Test</h3>
          <p>Call standard ETH methods via Snap.</p>
          <div style="display: flex; gap: 0.5rem; flex-wrap: wrap">
            <button id="get-chain-btn" class="btn" disabled>eth_chainId</button>
            <button id="get-block-btn" class="btn" disabled>
              eth_blockNumber
            </button>
            <button id="get-balance-btn" class="btn" disabled>
              eth_getBalance (Vitalik)
            </button>
            <button
              id="kill-client-btn"
              class="btn"
              style="background-color: #ef4444"
              disabled
            >
              Simulate Crash
            </button>
          </div>
          <pre id="rpc-output" style="margin-top: 1rem">
Waiting for commands...</pre
          >
        </div>
      </div>
    </div>

    <script>
      const snapId = `local:http://localhost:8081`; // Default local snap ID
      const connectBtn = document.getElementById("connect-btn");
      const initBtn = document.getElementById("init-btn");
      const getChainBtn = document.getElementById("get-chain-btn");
      const getBlockBtn = document.getElementById("get-block-btn");
      const getBalanceBtn = document.getElementById("get-balance-btn");
      const killClientBtn = document.getElementById("kill-client-btn");
      const statusDot = document.getElementById("status-dot");
      const connectionStatus = document.getElementById("connection-status");
      const rpcOutput = document.getElementById("rpc-output");

      // Helper to log
      const log = (el, msg) => {
        const timestamp = new Date().toLocaleTimeString();

        // Deep clone to avoid mutating original
        let displayMsg = JSON.parse(JSON.stringify(msg));

        // Caso 1: eth_getBalance (oggetto complesso con .balance o .result.balance)
        // Se Ã¨ annidato in result:
        const payload = displayMsg.result || displayMsg;

        if (payload.balance) {
          try {
            const wei = BigInt(payload.balance);
            const eth = Number(wei) / 1e18;
            // Aggiungiamo il campo leggibile direttamente nell'output
            if (displayMsg.result) {
              displayMsg.result.human_readable = `${eth.toFixed(4)} ETH`;
            } else {
              displayMsg.human_readable = `${eth.toFixed(4)} ETH`;
            }
          } catch (e) {}
        }

        // Caso 2: eth_blockNumber (stringa hex diretta)
        else if (
          typeof msg.result === "string" &&
          msg.result.startsWith("0x")
        ) {
          try {
            const decimal = parseInt(msg.result, 16);
            if (!isNaN(decimal)) {
              displayMsg.human_readable_block = decimal.toLocaleString();
            }
          } catch (e) {}
        }

        el.innerText = `[${timestamp}] ${JSON.stringify(displayMsg, null, 2)}`;
      };

      // 1. Connect
      connectBtn.addEventListener("click", async () => {
        try {
          await window.ethereum.request({
            method: "wallet_requestSnaps",
            params: {
              [snapId]: {},
            },
          });
          statusDot.classList.add("active");
          connectionStatus.innerText = "Snap Installed & Connected";
          initBtn.disabled = false;
          connectBtn.disabled = true;
          connectBtn.innerText = "Connected";
        } catch (err) {
          console.error(err);
          alert("Connection failed: " + err.message);
        }
      });

      // 2. Initialize
      initBtn.addEventListener("click", async () => {
        initBtn.innerText = "Initializing... (Wait ~10s)";
        initBtn.disabled = true;
        try {
          const result = await window.ethereum.request({
            method: "wallet_invokeSnap",
            params: {
              snapId: snapId,
              request: { method: "initialize" },
            },
          });
          document.getElementById("init-output").innerHTML =
            `<pre>${JSON.stringify(result, null, 2)}</pre>`;

          // Enable RPC buttons
          getChainBtn.disabled = false;
          getBlockBtn.disabled = false;
          getBalanceBtn.disabled = false;
          killClientBtn.disabled = false;
          initBtn.innerText = "Node Running";
        } catch (err) {
          console.error(err);
          document.getElementById("init-output").innerText =
            "Error: " + err.message;
          initBtn.disabled = false;
          initBtn.innerText = "Retry Initialize";
        }
      });

      // 3. RPC Tests
      getChainBtn.addEventListener("click", async () => {
        try {
          const res = await window.ethereum.request({
            method: "wallet_invokeSnap",
            params: {
              snapId: snapId,
              request: { method: "eth_chainId" },
            },
          });
          log(rpcOutput, { method: "eth_chainId", result: res });
        } catch (err) {
          log(rpcOutput, { error: err.message });
        }
      });

      getBlockBtn.addEventListener("click", async () => {
        try {
          const res = await window.ethereum.request({
            method: "wallet_invokeSnap",
            params: {
              snapId: snapId,
              request: { method: "eth_blockNumber" },
            },
          });
          log(rpcOutput, { method: "eth_blockNumber", result: res });
        } catch (err) {
          log(rpcOutput, { error: err.message });
        }
      });

      getBalanceBtn.addEventListener("click", async () => {
        try {
          const vitalik = "0xd8dA6BF26964aF9D7eEd9e03E53415D37aA96045";
          log(rpcOutput, { status: "Fetching balance securely..." });
          const res = await window.ethereum.request({
            method: "wallet_invokeSnap",
            params: {
              snapId: snapId,
              request: {
                method: "eth_getBalance",
                params: [vitalik],
              },
            },
          });
          log(rpcOutput, { method: "eth_getBalance", result: res });
        } catch (err) {
          log(rpcOutput, { error: err.message });
        }
      });

      killClientBtn.addEventListener("click", async () => {
        try {
          log(rpcOutput, { status: "Killing client..." });
          const res = await window.ethereum.request({
            method: "wallet_invokeSnap",
            params: {
              snapId: snapId,
              request: { method: "debug_killClient" },
            },
          });
          log(rpcOutput, { method: "debug_killClient", result: res });
          initBtn.innerText = "Node Killed (Simulated)";
          // Non disabilitiamo i bottoni RPC per testare la persistenza
        } catch (err) {
          log(rpcOutput, { error: err.message });
        }
      });
    </script>
  </body>
</html>
